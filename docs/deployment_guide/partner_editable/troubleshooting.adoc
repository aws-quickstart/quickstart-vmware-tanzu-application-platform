//Add any unique troubleshooting steps here.

For troubleshooting common Partner Solution issues, refer to the https://fwd.aws/rA69w?[AWS Partner Solution General Information Guide^] and https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/troubleshooting.html[Troubleshooting CloudFormation^].

=== {partner-product-name} documentation

Refer to the following resources to troubleshoot {partner-product-name}.

* https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/troubleshooting-tap-troubleshoot-install-tap.html[Troubleshoot installing {partner-product-short-name}^]
* https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/troubleshooting-tap-troubleshoot-using-tap.html[Troubleshoot using {partner-product-short-name}^]

=== I can't access the {partner-product-short-name} user interface

* Problem
** Inability to access the {partner-product-short-name} user interface after deployment.

* Cause
** The deployment failed to complete successfully.
** You are attempting to accessing the site from a location that doesn't have connectivity to the {partner-product-short-name} GUI.

* Solution
** Verify that the CloudFormation stack deployment completed successfully.
** If the stack deployed successfully, review the {partner-product-short-name} bootstrap logs.
** The {partner-product-short-name} website GUI URL can only be accessed from endpoints with a route to the private VPC network, such as from the Amazon EC2 Windows bastion host instance.

=== {partner-product-short-name} installation failed with a EULA error

* Problem
** The deployment failed to complete successfully.

* Cause
** The EULA was not accepted.

* Solution
** You must accept the relevant EULAs before you can download the {partner-product-short-name} packages from the {partner-registry}. For more information, refer to https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/install-tanzu-cli.html#accept-the-end-user-license-agreements-0[Accept the End User License Agreements^].
** For more details about the `+.status.usefulErrorMessage+` error, connect to the Linux bastion host using SSH. Then run the following commands. For `<PACKAGE-NAME>`, substitute the name of the package to target.
+
----
tanzu package installed list -A
tanzu package installed get <PACKAGE-NAME> --namespace tap-install
----
+
** If you have chosen to relocate {partner-product-short-name} images to Amazon ECR and this did not complete successfully, run the following command. This command takes 30–45 minutes to complete.
+
----
/home/ubuntu/tap-setup-scripts/src/tap-main.sh -c relocate
----
+
** Run the following command to install {partner-product-short-name}.
+
----
/home/ubuntu/tap-setup-scripts/src/tap-main.sh -c install
----

=== One or more {partner-product-short-name} packages failed to reconcile

* Problem
** {partner-product-short-name} packages fail to reconcile.

* Cause
** An infrastructure issue causing the task to take longer to run than the timeout value allows.
** A race condition between components.

* Solution
** Connect to the Linux bastion host using SSH. Then run the following command to verify the installation status.
+
----
tanzu package installed list -A
----
+
** If the installation has stopped running, one or more reconciliations have likely failed.
** If so, run the following command.
** For the single cluster install of Quickstart, run the following command.
+
----
/home/ubuntu/tap-setup-scripts/src/tap-main.sh -c install single
----
+
** For the multi cluster install of Quickstart, run the command against the cluster with packages not reconciling. The cluster types for multi cluster are "view", "run", "iterate", or "build." Pass the cluster type into the install command.
+
----
/home/ubuntu/tap-setup-scripts/src/tap-main.sh -c install <cluster-type>
----

=== It's been more than four minutes and the Windows bastion host administrator password still isn't available

* Problem
** Inability to log into Windows bastion EC2 instance

* Cause
** It is likely that during deployment an ED25519 key pair was used instead of an RSA key pair. If you select an ED25519 key pair for this deployment, the CloudFormation stack deploys successfully, but you will be unable to retrieve the automatically generated password for the Windows bastion host.
** As of June 23rd, 2022, Amazon EC2 Windows instances do not support ED25519 key pairs. For more information, refer to https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-key-pairs.html[Amazon EC2 key pairs and Windows instances^].

* Solution
** Verify that an RSA key pair used during deployment. If not, try the following options:
** If an RSA key pair has not been created, try the following steps: https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ResettingAdminPassword_EC2Launchv2.html[Reset the Windows administrator password using EC2Launch v2^]
** https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-direct.html[Update the CloudFormation stack^] to use an RSA key pair, which will replace all Amazon EC2 instances (Windows and Linux) and Amazon EKS nodes that use this key. For more information, refer to the https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html#cfn-ec2-instance-keyname[documentation^].
** Customize the CloudFormation template to use a separate key pair for the Windows bastion host. Then update the CloudFormation stack. This option only replaces the Windows bastion host instance. Instructions for implementing this are beyond the scope of this guide.
** https://aws.amazon.com/contact-us/[Contact AWS technical support^].

=== Search logs for deployment failures

* Problem
** A deployment takes over two hours to complete.
** How to find logs to debugs Quickstart failures?

* Cause
** CloudFormation fails.
** No notifaction of Quickstart deployment completion.

* Solution
** Sign in to the https://console.aws.amazon.com/console/home[AWS Management Console^], and open the CloudFormation console.
** Select the Quickstart base stack and click the Outputs tab and copy the TAPLogGroupId.
+
image:../docs/deployment_guide/images/TAPLogGroupOutput.PNG[LogGroupOutput]
+
** Search the CloudWatch log groups for the TAPLogGroupId.
+
image:../docs/deployment_guide/images/CloudWatchLogGroup.PNG[CloudWatchLogGroup]
+
** Select the log group to view the log streams file "/var/log/cloud-init-output.log" where the tap setup scripts output from the Linux Bastion EC2 instance is.
+
image:../docs/deployment_guide/images/CloudInitOutput.PNG[CloudInitOutput]
+
** Logs can also be found in the `+/var/log/cloud-init-output.log+` file on the Linux bastion host.


=== Debug CloudFormation deployment failures

* Problem
** Quickstart CloudFormation deployment fails.

* Cause
** TAP packages may have failed to reconcile.
** Cloud-init scripts may have failed.

* Solution
** Select inner-most nested failed CloudFormation stack.
+
image:../docs/deployment_guide/images/NestedFailedStack.PNG[NestedFailedStack]
+
** Select the CloudFormation Events tab.
+
image:../docs/deployment_guide/images/FailedStackEvents.PNG[FailedStackEvents]
+
** Find the error description in the "Status reason" column.
** Correct the error if possible, then update the stack from the "Stack actions" dropdown on the top right corner of the console.
** If the CloudFormation stack is in "ROLLBACK_FAILED" state, delete the stack and redeploy Quickstart.

=== Quickstart CloudFormation cleanup

* Problem
** Quickstart fails to delete.

* Cause
** Inability to completely delete Quickstart CloudFormation resources.
** VPC does not delete after Quickstart CloudFormation delete operation.
+
image:../docs/deployment_guide/images/VpcDelete.PNG[VpcDelete]

* Solution
** There is a dependency on the security group which prevents the Quickstart VPC from deleting the first time.
** Manually delete the VPC.
** Once the VPC deletes successfully, manually delete the top level CloudFormation stack by selecting the exclude resource option.Vp
+
image:../docs/deployment_guide/images/VPCManualDelete.PNG[VPCManualDelete]

=== Input parameter failures

* Problem
** Invalid Availability Zones or Number of Availability Zones.
** Invalid Remote Access CIDR provided.
** EC2 Key pair does not show up in dropdown.

* Cause
** Using Availability Zones which are not present or restricted in the AWS region.
** List of Availability Zones and Number of Availability Zones do not match.
** Entering invalid or incorrectly formatted Remote Access CIDR.
** Key pair does not exist.

* Solution
** Ensure Availability Zones are present in the AWS region the Quickstart is deploying to.
** Ensure the List of Availability Zones and Number of Availability Zones match.
+
image:../docs/deployment_guide/images/AvailabilityZones.PNG[AvailabilityZones]
+
** Provide a valid Remote Access CIDR for your machine to connect to the Windows or Linux Bastion EC2 instance in the VPC.
+
image:../docs/deployment_guide/images/RemoteCIDR.PNG[RemoteCIDR]
+
** If a key pair exists, it can be used to SSH into the Linux Bastion EC2 instance in the VPC. If a key pair does not exist, create one and it will show up in the drop down.
+
image:../docs/deployment_guide/images/KeyPair.PNG[KeyPair]

=== RegionalSharedResources and AccountSharedResources not removed after Quickstart CloudFormation delete

* Problem
** RegionalSharedResources and AccountSharedResources CloudFormation stacks are not removed after QuickStart CFT is deleted.
** RegionalSharedResources OR AccountSharedResources CFTs failed to deploy

* Cause
** AWS Resources created by RegionalSharedResources and the AccountSharedResources CFTs such as IAM Roles are left behind even after QuickStart CFT is deleted.

* Solution
** RegionalSharedResources stack creates AWS resources for each region Quickstart is deployed.
+
image:../docs/deployment_guide/images/RegionalStack.PNG[RegionalStack]
+
** AccountSharedResources stack creates AWS resources in a single region where Quickstart is deployed.
+
image:../docs/deployment_guide/images/AccountStack.PNG[AccountStack]
+
** RegionalSharedResources and AccountSharedResources stacks remain deployed by design and are meant to persist between Quickstart deployments.
** If RegionalSharedResources or AccountSharedResources stacks failed to deploy, remove the IAM roles created by SharedResources stacks. Roles that include "qs" or "quickstart" are those created by SharedResources.
** If multiple Quickstart stacks are running simultaneously in multiple regions, conflicting IAM roles may result in failure to deploy or clean up SharedResources stacks. Delete all IAM roles associated with the Quickstart and deploy a Quickstart in a single region. The SharedResources stacks will be newly created.

=== CloudFormation IAM roles

* Problem
** IAM role is used to perform CloudFormation operations.

* Cause
** Using a custom role to deploy Quickstart.

* Solution
** Using a custom role is optional and not advised for deploying Quickstart.
+
image:../docs/deployment_guide/images/QSIamRoleOptional.PNG[QSIamRoleOptional]

=== TAP Workload deployment fails

* Problem
** CloudFormation and TAP installation succeeds but workload fails to run.

* Cause
** TAP workload URL is not accessible from the Linux or Windows Bastion EC2 instances.
** TAP workload is not visible in the TAP GUI supply chain.

* Solution
** SSH to the 'VMwareLinuxBastionInstance' EC2 instance and run the below commands. They will provide the workload status and logs that contain error messages.
+
----
tanzu apps workload list -n tap-workload
tanzu apps workload tail tanzu-java-web-app-workload -n tap-workload --since 10m –timestamp
----
+
** If the status and logs do not contain errors, ensure DNS is correctly configured by checking Route53 and ensuring the private zone has the respective kubernetes cluster envoy-IP configured in CNAME records.
** Route53 Single cluster configuration.
+
image:../docs/deployment_guide/images/Route53Single.PNG[Route53Single]
+
** Route53 Multi cluster configuration.
+
image:../docs/deployment_guide/images/Route53Multi.PNG[Route53Multi]

// git log --reverse origin/main...v1.4.0 -- ':!/ci/'

// Changelog links
:imds-v2: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html
:tap-1_4_2-cl: https://docs.vmware.com/en/VMware-Tanzu-Application-Platform/1.4/tap/release-notes.html#v142-0
:ce-1_4_1-cl: https://docs.vmware.com/en/Cluster-Essentials-for-VMware-Tanzu/1.4/cluster-essentials/release-notes.html#v141-0
:eks-1_24-cl: https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html#kubernetes-1.24
:eksqs-5_0_0-cl: https://github.com/aws-quickstart/quickstart-amazon-eks/releases/tag/v5.0.0

=== Version 1.4.2+aws.1
* Bugfix: Relocation of the TAP images was broken, this release fixes that.
* Removed the following configuration options:
** EKS Cluster name.
* The bastion hosts now use {imds-v2}[Instance Metadata Service Version 2 (IMDSv2)].
* We changed how we check and deploy the shared resources stacks
  (`eks-quickstart-RegionalSharedResources` & `eks-quickstart-AccountSharedResources`) which results in slightly faster deployments
  and less chance to run into race-conditions.

=== Version 1.4.2+aws.0
* The stack now reports the status of the  {partner-product-short-name} deployment and installation of the sample application  after all of the infrastructure has been deployed.
* Fixed an issue that occurred when deleting VPCs because of stale security groups.
* Upgraded the following versions:
** {tap-1_4_2-cl}[{partner-product-acronym}^] 1.4.2.
** {ce-1_4_1-cl}[ClusterEssentials^] 1.4.
** {eksqs-5_0_0-cl}[EKS QuickStart^] 5.0.0.
** {eks-1_24-cl}[EKS^] 1.24.
* Removed the following configuration options:
** {partner-product-short-name} version.
** EKS version.
** Linux Bastion host AMI.
** Linux Bastion host's SSH port.
** Sample application name.
* Fixed an issue with downloading artifacts (for example, `kubectl`) for Regions other than `us-east-1`.

=== Version 1.4.0
* You can now deploy a multicluster architecture by setting the *EKS single or multicluster / TAP cluster architecture* (`TAPClusterArch`) parameter to `multi`.
